{"version":3,"sources":["V3/EventEmitter.js","V3/util.js","V3/evmEventsMap.js","V3/evm.js"],"names":["isListener","listener","pureObject","Object","create","EventEmitter","event","eventName","listeners","args","i","length","apply","once","TypeError","push","index","findIndex","l","splice","createPureObject","createRevocableProxy","obj","handler","Proxy","revocable","createApplyHanlder","callback","target","ctx","concat","Reflect","arguments","EvmEventsMap","WeakMap","fn","wp","t","get","set","f","keys","delete","orgEventTargetPro","EventTarget","prototype","EVM","add","emit","remove","on","off","offAll","addEventListener","proxy","removeEventListener","cancelWatch","revoke","getData"],"mappings":"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","file":"evm.e1135928.js","sourceRoot":"..","sourcesContent":["\r\nfunction isListener(listener) {\r\n    if (typeof listener === 'function') {\r\n        return true\r\n    }\r\n    return false;\r\n}\r\n\r\n\r\nconst pureObject = Object.create(null);\r\n\r\nexport default class EventEmitter {\r\n\r\n    #events = pureObject;\r\n\r\n    #addListener(event, listener, once) {\r\n        if (!event || !listener) return false;\r\n\r\n        if (!isListener(listener)) {\r\n            throw new TypeError('listener must be a function');\r\n        }\r\n        const listeners = (this.#events[event] = this.#events[event] || []);\r\n        listeners.push({\r\n            listener,\r\n            once\r\n        });\r\n\r\n        return true;\r\n    }\r\n\r\n    #removeListener(event, listener) {\r\n        const listeners = this.#events[event];\r\n        if (!listeners) return false;\r\n\r\n        const index = listeners.findIndex(l => l.listener === listener);\r\n\r\n        // 如果不是 -1， ~-1 =  -(-1 + 1) = 0\r\n        if (~index) {\r\n            listeners.splice(index, 1);\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    on(event, listener) {\r\n        this.#addListener(event, listener, false);\r\n        return this;\r\n    };\r\n\r\n    once(event, listener) {\r\n        this.#addListener(event, listener, true);\r\n        return this;\r\n    };\r\n\r\n    off(event, listener) {\r\n        this.#removeListener(event, listener);\r\n        return this;\r\n    };\r\n\r\n    offAll(eventName) {\r\n        if (eventName && this.#events[eventName]) {\r\n            this.#events[eventName] = []\r\n        } else {\r\n            this.#events = pureObject\r\n        }\r\n        return this;\r\n    };\r\n\r\n    emit(event, ...args) {\r\n        const listeners = this.#events[event];\r\n        if (!listeners) return;\r\n\r\n        for (let i = 0; i < listeners.length; i++) {\r\n            const listener = listeners[i];\r\n            if (!listener) {\r\n                continue;\r\n            }\r\n            listener.listener.apply(this, args);\r\n            // TODO??\r\n            if (listener.once && this.#removeListener(event, listener.listener)) {\r\n                i--;\r\n            }\r\n        }\r\n        return this;\r\n    };\r\n}","\r\n/**\r\n * 创建纯净对象\r\n * @returns \r\n */\r\nexport function createPureObject() {\r\n    return Object.create(null);\r\n}\r\n\r\n/**\r\n * 创建可取消的代理\r\n * @param obj \r\n * @param handler \r\n * @returns \r\n */\r\nexport function createRevocableProxy(obj, handler) {\r\n    return Proxy.revocable(obj, handler);\r\n}\r\n\r\n/**\r\n * 创建拦截函数调用的代理\r\n * @param callback \r\n * @returns \r\n */\r\nexport function createApplyHanlder(callback) {\r\n    return {\r\n        apply(target, ctx, args) {\r\n            callback(...[ctx].concat(args));\r\n            return Reflect.apply(...arguments);\r\n        }\r\n    }\r\n}","import { createPureObject } from \"./util.js\"\r\n\r\nexport default class EvmEventsMap {\r\n\r\n    #wp = new WeakMap();\r\n\r\n    add(target, event, fn) {\r\n        const wp = this.#wp;\r\n        let t = wp.get(target);\r\n        if (!t) {\r\n            t = createPureObject();\r\n            wp.set(target, t);\r\n        }\r\n        if (!t[event]) {\r\n            t[event] = [];\r\n        }\r\n        t[event].push(fn);\r\n    }\r\n\r\n    remove(target, event, fn) {\r\n        const wp = this.#wp;\r\n        let t = wp.get(target);\r\n        if (!t) {\r\n            return;\r\n        }\r\n        if (!t[event]) {\r\n            return;\r\n        }\r\n        const index = t[event].findIndex((f) => f === fn);\r\n        if (index >= 0) {\r\n            t[event].splice(index, 1);\r\n        }\r\n        if (t[event].length === 0) {\r\n            delete t[event];\r\n        }\r\n        if (Object.keys(t).length === 0) {\r\n            wp.delete(target);\r\n        }\r\n    }\r\n\r\n    getData() {\r\n        return this.#wp\r\n    }\r\n}","\nimport EventEmitter from \"./EventEmitter.js\";\nimport EvmEventsMap from \"./evmEventsMap.js\";\nimport { createRevocableProxy, createApplyHanlder } from \"./util.js\"\n\n// 保留原始的原型\nconst orgEventTargetPro = { ...EventTarget.prototype };\n\nexport default class EVM {\n\n  #ep = EventTarget.prototype;\n  #rvAdd;\n  #rvRemove;\n  #emitter = new EventEmitter();\n  #eventsMap = new EvmEventsMap();\n\n  onAdd(fn) {\n    this.#emitter.on(\"on-add\", fn)\n  }\n\n  offAdd(fn) {\n    this.#emitter.off(\"on-add\", fn)\n  }\n\n  onRemove(fn) {\n    this.#emitter.on(\"on-remove\", fn)\n  }\n\n  offRemove() {\n    this.#emitter.off(\"on-remove\", fn)\n  }\n\n  offAll() {\n    this.#emitter.offAll();\n  }\n\n  #innerAddCallback = (...args) => {\n    this.#eventsMap.add(...args);\n    this.#emitter.emit(\"on-add\", ...args)\n  }\n\n  #innerRemoveCallback = (...args) => {\n    this.#eventsMap.remove(...args);\n    this.#emitter.emit(\"on-remove\", ...args)\n  }\n\n  watch() {\n    this.#rvAdd = createRevocableProxy(this.#ep.addEventListener,\n      createApplyHanlder(this.#innerAddCallback));\n    this.#ep.addEventListener = this.#rvAdd.proxy;\n\n    this.#rvRemove = createRevocableProxy(this.#ep.removeEventListener,\n      createApplyHanlder(this.#innerRemoveCallback));\n    this.#ep.removeEventListener = this.#rvRemove.proxy;\n\n    return () => this.cancelWatch();\n  }\n\n  cancelWatch() {\n    if (this.#rvAdd) {\n      this.#rvAdd.revoke();\n    }\n    this.#ep.addEventListener = orgEventTargetPro.addEventListener;\n\n    if (this.#rvRemove) {\n      this.#rvRemove.revoke();\n    }\n    this.#ep.removeEventListener = orgEventTargetPro.removeEventListener;\n  }\n\n  getData() {\n    return this.#eventsMap.getData();\n  }\n\n}"]}